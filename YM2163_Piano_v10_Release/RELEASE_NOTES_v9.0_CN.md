# YM2163 Piano GUI v9.0 发布说明

## 发布日期
2026年1月28日

## 版本信息
v9.0 (Build 2026-01-28-Final)

---

## 🎉 主要新功能

### 1. 鼓声动态分配系统
- **智能芯片分配**：双芯片模式下，鼓声在两个芯片间轮流分配
- **独立UI显示**：每个芯片单独显示鼓声状态，不再同时亮起
- **实时日志**：显示当前使用的芯片编号，便于调试
- **适用范围**：
  - 数字键盘 Numpad 1-5 触发
  - UI鼓声按钮点击
  - MIDI播放中的鼓声

### 2. 文件浏览器高亮系统
- **退出文件夹高亮**：
  - 返回上级目录时，刚退出的文件夹显示黄色高亮
  - 高亮持续显示，直到进入其他文件夹
  - 自动滚动到高亮的文件夹位置
- **播放路径高亮**：
  - 当前播放文件所在的文件夹显示浅蓝色高亮
  - 父目录路径也显示浅蓝色高亮
  - 便于识别当前播放文件的位置

### 3. 文件名滚动显示
- **自动检测**：检测超长文件名（超出显示宽度）
- **触发条件**：
  - 鼠标悬停（hover）的条目
  - 选中的条目
  - 高亮的文件夹
- **滚动动画**：
  - 缓慢从左向右滚动（30像素/秒）
  - 到达右端停顿1秒
  - 缓慢从右向左滚动
  - 到达左端停顿1秒
  - 循环往复
- **适用范围**：MIDI文件和文件夹都支持

### 4. 滚动条位置记忆
- **自动保存**：每帧保存当前滚动位置
- **自动恢复**：进入子目录后返回，自动恢复到之前的滚动位置
- **便于定位**：文件夹很多时快速定位到之前浏览的位置

### 5. 长路径支持
- **自动处理**：路径超过260字符时自动添加 `\\?\` 前缀
- **详细错误提示**：
  - 文件不存在
  - 路径不存在
  - 访问被拒绝
  - 路径过长（显示字符数和建议）
- **突破限制**：支持Windows长路径（超过MAX_PATH限制）

### 6. 进度条跳转优化
- **精确跳转**：
  - 重置 `accumulatedTime` 为目标时间
  - 重置高精度计时器 `lastPerfCounter`
  - 重新计算播放时间偏移
- **音符重建**：调用 `RebuildActiveNotesAfterSeek()` 恢复应该播放的音符
- **无延迟响应**：立即响应，不会瞬间播放大量音符或没反应

### 7. 切换曲目优化
- **清除残留按键**：切换曲目时重置所有钢琴键UI状态
- **避免冲突**：清除活动音符和鼓声状态
- **芯片重置**：自动重置YM2163芯片，消除残留声音

### 8. 动态音量映射
- **自动MIDI分析**：加载MIDI文件时分析力度分布
- **智能映射**：
  - 最常见的力度 → -6dB 和 -12dB
  - 峰值力度（95百分位） → 0dB
  - 极低力度 → 静音
- **自适应控制**：为不同MIDI文件提供更好的音量平衡

### 9. Unicode文件名支持
- **CJK字体支持**：完整支持中文、日文、韩文字符
- **字体合并**：组合多个字体以实现完整字符覆盖
  - 主字体：Microsoft YaHei（中文）
  - 次字体：Malgun Gothic（韩文）
  - 第三字体：MS Gothic（日文）
- **UTF-8处理**：整个应用程序中正确的字符串处理

### 10. Win11风格地址栏
- **面包屑导航**：点击目录按钮进行导航
- **智能截断**：长路径显示"..."，优先显示当前目录
- **文件夹名简写**：过长的文件夹名自动简写为 "1234...7890" 格式
- **双模式**：
  - 面包屑模式（默认）：点击按钮导航
  - 文本输入模式：双击进入直接输入路径
- **向上箭头按钮**：快速导航到父目录

### 11. 文件浏览器改进
- **单击操作**：统一使用单击播放和单击选中
- **历史记录排序**：最近打开的目录显示在前面
- **自动重排序**：重新访问目录会移到顶部
- **持久化存储**：保存到 ym2163_folder_history.ini

### 12. 时间驱动的MIDI进度
- **高精度计时**：使用 QueryPerformanceCounter（微秒精度）
- **平滑动画**：进度条平滑移动，无跳跃
- **准确显示**：显示 MM:SS 格式的当前和总时间
- **拖动支持**：拖动进度条快速跳转到任意位置

---

## 🐛 Bug修复

### 播放相关
- ✅ 修复进度条跳转后没反应或瞬间播放大量音符的问题
- ✅ 修复延长音时切换曲目导致UI钢琴键盘残留按下的键
- ✅ 修复双击加载文件时没有芯片重置的问题

### UI相关
- ✅ 修复鼓声UI两个芯片同时亮起的问题
- ✅ 修复退出文件夹时高亮一闪而过的问题
- ✅ 修复滚动条位置没有记录和恢复的问题
- ✅ 修复切换Slot1时布局宽度变化的问题
- ✅ 修复地址栏焦点丢失问题

### 文件处理
- ✅ 修复Unicode字符显示问题
- ✅ 修复长路径文件无法加载的问题
- ✅ 改进错误提示信息的清晰度

---

## 🔧 技术细节

### 鼓声动态分配实现
```cpp
void play_drum(uint8_t rhythm_bit) {
    int chipIndex = 0;
    if (g_enableSecondYM2163) {
        chipIndex = g_currentDrumChip;
        g_currentDrumChip = 1 - g_currentDrumChip;  // 轮流切换
    }
    write_melody_cmd_chip(0x90, chipIndex);
    write_melody_cmd_chip(rhythm_bit, chipIndex);

    // 为每个芯片单独跟踪鼓声状态
    g_drumActive[chipIndex][i] = true;
}
```

### 进度条跳转修复
```cpp
// 重置高精度计时器
QueryPerformanceCounter(&g_midiPlayer.lastPerfCounter);

// 重新计算累积时间
double ticksPerMicrosecond = ticksPerQuarterNote / tempo;
g_midiPlayer.accumulatedTime = targetMidiTick / ticksPerMicrosecond;

// 重建音符状态
RebuildActiveNotesAfterSeek(targetEventIndex);
```

### 文件名滚动动画
```cpp
struct TextScrollState {
    float scrollOffset;        // 当前滚动偏移
    float scrollDirection;     // 1.0=右, -1.0=左
    float pauseTimer;          // 停顿计时器
    std::chrono::steady_clock::time_point lastUpdateTime;
};

// 滚动速度：30像素/秒
// 停顿时间：1秒
```

### 长路径支持
```cpp
// 路径超过260字符时添加长路径前缀
if (wFilename.length() > 260) {
    wFilename = L"\\\\?\\" + wFilename;
}
```

### 动态音量映射分析
```
分析内容：
- 总音符数
- 力度范围（最小/最大）
- 平均力度
- 峰值力度（95百分位）
- 最常见的力度（前2个）
- 每个音量级别的计算阈值
```

### 字体加载策略
```
优先级顺序：
1. Microsoft YaHei (msyh.ttc) - CJK支持
2. Malgun Gothic (malgun.ttf) - 韩文支持
3. MS Gothic (msgothic.ttc) - 日文支持
4. Segoe UI (segoeui.ttf) - 西文支持
5. ImGui默认字体 - 后备方案
```

### 芯片重置序列
```
对每个芯片：
1. 发送所有4个通道的音符关闭
2. 设置所有音量为静音
3. 重置所有包络为衰减
4. 重置所有波形/音色为0
5. 关闭所有节奏声音
6. 等待50ms稳定
```

---

## 📊 性能改进

- 减少MIDI播放期间的CPU使用率
- 改进字体渲染性能
- 优化文件浏览器响应速度
- 更好的大型MIDI文件内存管理
- 高精度计时器减少延迟

---

## ⚠️ 已知限制

- 最多20个MIDI文件夹历史记录条目
- 单个MIDI文件播放（无播放列表）
- 限制为8个通道（每个芯片4个）
- 需要SPFM硬件进行音频输出
- Windows MAX_PATH限制（260字符）已通过长路径支持突破

---

## 💻 系统要求

- Windows 10/11（64位）
- SPFM硬件，带YM2163芯片
- FTDI USB驱动程序
- 100MB可用磁盘空间

---

## 📦 安装说明

1. 解压 YM2163_Piano_v9_Release.tar.gz
2. 运行 ym2163_piano_gui_v9.exe
3. 确保 ym2163_midi_config.ini 存在
4. 通过USB连接SPFM硬件

---

## 🔨 从源代码构建

```bash
cd YM2163_Piano_v9_Release
./build_v9.sh
```

---

## 📝 从v8的更新日志

### 新增功能
- ✨ 鼓声动态分配系统
- ✨ 文件浏览器高亮系统（退出文件夹、播放路径）
- ✨ 文件名滚动显示
- ✨ 滚动条位置记忆
- ✨ 长路径支持
- ✨ 动态音量映射
- ✨ Win11风格地址栏
- ✨ 文件夹名自动简写

### 改进功能
- 🔧 进度条跳转优化
- 🔧 切换曲目优化
- 🔧 Unicode文件名支持增强
- 🔧 历史目录排序改进
- 🔧 文件浏览器单击操作统一
- 🔧 时间驱动的MIDI进度确认

### Bug修复
- 🐛 修复鼓声UI显示问题
- 🐛 修复进度条跳转问题
- 🐛 修复钢琴键残留问题
- 🐛 修复文件夹高亮问题
- 🐛 修复滚动条位置问题
- 🐛 修复长路径加载问题
- 🐛 修复多个UI布局问题
- 🐛 改进整体稳定性

---

## 🗺️ 未来路线图

- 播放列表支持
- MIDI文件编辑功能
- 高级频率调谐界面
- 实时频谱分析器
- 录音功能
- 更多芯片支持

---

## 📞 支持与反馈

如有错误报告和功能请求，请访问项目仓库。

---

## 🙏 致谢

- YM2163芯片文档
- SPFM硬件支持
- ImGui框架
- MidiFile库
- FTDI驱动程序支持
- 所有测试用户的反馈

---

## 📄 许可证

本项目遵循开源许可证。详见LICENSE文件。

---

**版本历史**：v1.0 → v2.0 → v3.0 → v4.0 → v5.0 → v6.0 → v7.0 → v8.0 → **v9.0**

**最后更新**：2026年1月28日 23:53
